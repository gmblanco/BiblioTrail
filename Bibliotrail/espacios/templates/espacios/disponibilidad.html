{% extends "BibliotrailApp/base.html" %}
{% load static %}

{% block title %}
<title>Reserva de espacios</title>
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h2 class="fw-bold mb-3" style="color: #6595f0;">Reserva de espacios por franja horaria</h2>
      <p class="text-muted">Consulta la disponibilidad de espacios en una biblioteca específica y filtra por fecha y capacidad.</p>
    </div>
    <i class="bi bi-grid-3x3-gap-fill fs-3 text-info"></i>
  </div>

  <!-- Formulario de búsqueda -->
  <form id="form-busqueda" class="row g-3 align-items-end mb-4">
    <div class="col-md-4">
      <label for="selector-biblioteca" class="form-label">Biblioteca</label>
      <select id="selector-biblioteca" name="biblioteca" class="form-select" required>
        <option value="todas" {% if biblioteca == "todas" %}selected{% endif %}>Todas las bibliotecas</option>
        {% for clave, url in bibliotecas.items %}
          <option value="{{ clave }}" {% if clave == biblioteca %}selected{% endif %}>{{ clave|title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="capacidad-minima" class="form-label">Capacidad mínima</label>
      <input type="number" id="capacidad-minima" name="capacidad_minima" class="form-control" value="{{ request.GET.capacidad_minima }}">
    </div>
    <div class="col-md-3">
      <label for="selector-fecha" class="form-label">Fecha</label>
      <input type="date" id="selector-fecha" name="fecha" class="form-control" value="{{ fecha|date:'Y-m-d' }}">
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-primary">Buscar disponibilidad</button>
    </div>
  </form>

  <!-- Tabla de disponibilidad -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered text-center align-middle shadow-sm">
      <thead class="table-light">
        <tr>
          <th scope="col">Biblioteca</th>
          <th scope="col">Espacio</th>
          {% for hora in horas %}
            <th scope="col">{{ hora }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for espacio in espacios %}
          <tr>
            <td class="text-muted small">{{ espacio.biblioteca|title }}</td>
            <td class="fw-semibold text-start">
              <a href="#"
                 class="enlace-detalle-espacio"
                 data-nombre="{{ espacio.nombre }}"
                 data-ubicacion="{{ espacio.ubicacion }}"
                 data-capacidad="{{ espacio.capacidad }}">
                {{ espacio.nombre }}
              </a>
            </td>
            {% for bloque in espacio.bloques %}
              {% if bloque.disponible %}
                <td class="reserva-celda"
                    role="button"
                    tabindex="0"
                    style="cursor:pointer; background-color: #74d774;"
                    data-espacio-id="{{ espacio.id }}"
                    data-espacio-nombre="{{ espacio.nombre }}"
                    data-inicio="{{ bloque.hora_inicio }}"
                    data-fin="{{ bloque.hora_fin }}"
                    data-biblioteca="{{ espacio.biblioteca }}"  
                    title="Disponible">
                  &nbsp;
                </td>

              {% else %}
                <td style="background-color: #dc3545; cursor: not-allowed;" title="No disponible">
                  &nbsp;
                </td>
              {% endif %}

            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Leyenda -->
  <div class="mt-4">
    <h6 class="fw-bold">Estado de las reservas:</h6>
    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
      <div style="width: 20px; height: 20px; border-radius: 4px; background-color: #74d774;"></div>
      <span>Disponible</span>
      <div class="ms-4" style="width: 20px; height: 20px; border-radius: 4px; background-color: #dc3545;"></div>
      <span>Ocupado</span>
    </div>
  </div>

  <div class="alert alert-secondary shadow-sm mt-5" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    Recuerda que cada reserva es personal y no transferible. Puedes consultar y cancelar tus reservas activas desde la sección <strong>Mis Reservas</strong>.
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalEspacio" tabindex="-1" aria-labelledby="modalEspacioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEspacioLabel">Detalle del espacio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p><strong>Nombre:</strong> <span id="modal-nombre"></span></p>
        <p><strong>Ubicación:</strong> <span id="modal-ubicacion"></span></p>
        <p><strong>Capacidad:</strong> <span id="modal-capacidad"></span> personas</p>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<form style="display: none;">{% csrf_token %}</form>
<script>
  function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  document.querySelectorAll('.reserva-celda').forEach(celda => {
    celda.addEventListener('click', async () => {
      const espacioId = celda.dataset.espacioId;
      const espacioNombre = celda.dataset.espacioNombre;
      const horaInicio = celda.dataset.inicio;
      const horaFin = celda.dataset.fin;
      const fecha = document.getElementById("selector-fecha").value;
      const biblioteca = celda.dataset.biblioteca;

      if (confirm(`¿Deseas reservar "${espacioNombre}" de ${horaInicio} a ${horaFin} en ${fecha}?`)) {
        const response = await fetch("/reservas/api/reservar/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({
            espacio_id: espacioId,
            titulo: espacioNombre,
            biblioteca: biblioteca,
            fecha: fecha,
            hora_inicio: horaInicio,
            hora_fin: horaFin
          })
        });

        const data = await response.json();
        if (data.success) {
          alert("Reserva realizada correctamente.");
          location.reload();
        } else {
          alert("Error al realizar la reserva: " + (data.error || "Inténtalo de nuevo."));
        }
      }
    });
  });

  document.querySelectorAll('.enlace-detalle-espacio').forEach(enlace => {
    enlace.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById("modal-nombre").textContent = enlace.dataset.nombre;
      document.getElementById("modal-ubicacion").textContent = enlace.dataset.ubicacion;
      document.getElementById("modal-capacidad").textContent = enlace.dataset.capacidad;
      new bootstrap.Modal(document.getElementById('modalEspacio')).show();
    });
  });

  document.getElementById("form-busqueda").addEventListener("submit", function(e) {
    e.preventDefault();
    const biblioteca = document.getElementById("selector-biblioteca").value;
    const capacidad = document.getElementById("capacidad-minima").value;
    const fecha = document.getElementById("selector-fecha").value;

    if (!biblioteca) {
      alert("Por favor, selecciona una biblioteca.");
      return;
    }

    const url = new URL(window.location.href);
    url.searchParams.set("biblioteca", biblioteca);
    url.searchParams.set("fecha", fecha);
    if (capacidad) {
      url.searchParams.set("capacidad_minima", capacidad);
    } else {
      url.searchParams.delete("capacidad_minima");
    }

    window.location.href = url.toString();
  });
</script>
{% endblock %}
