{% extends "BibliotrailApp/base.html" %}
{% load static %}

{% block title %}
  <title>Calendario de eventos</title>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary fw-bold">Calendario de eventos</h2>

    <!-- Menú desplegable de biblioteca -->
    <form method="get" id="selectorBiblioteca" class="d-flex align-items-center">
      <select name="biblioteca" class="form-select" onchange="this.form.submit()">
        {% for nombre, url in bibliotecas.items %}
          <option value="{{ nombre }}" {% if biblioteca == nombre %}selected{% endif %}>
            {{ nombre|capfirst }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- Calendario -->
  <div id="calendario" style="max-width: 100%; margin: 0 auto;"></div>
</div>

<!-- Modal Bootstrap -->
<div class="modal fade" id="modalEvento" tabindex="-1" aria-labelledby="modalEventoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalEventoLabel">Detalles del evento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p id="detalleTitulo" class="fw-bold"></p>
        <p id="detalleLugar"></p>
        <p id="detalleBiblioteca"></p>
        <p id="detallePlazas"></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- Bootstrap JS (asegúrate de que no esté duplicado si ya lo tienes en base.html) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendario');
      const biblioteca = new URLSearchParams(window.location.search).get("biblioteca");

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        events: `/eventos/calendario/eventos/?biblioteca=${biblioteca}`,
        eventDisplay: 'block',

        eventClick: function(info) {
          const props = info.event.extendedProps;
          document.getElementById("detalleTitulo").innerHTML = `<strong>${info.event.title}</strong>`;
          document.getElementById("detalleLugar").innerHTML = `<i class="bi bi-geo-alt-fill"></i> <strong>Lugar:</strong> ${props.lugar}`;
          document.getElementById("detalleBiblioteca").innerHTML = `<i class="bi bi-building"></i> <strong>Biblioteca:</strong> ${props.biblioteca}`;
          document.getElementById("detallePlazas").innerHTML = `<i class="bi bi-people-fill"></i> <strong>Plazas disponibles:</strong> ${props.plazas_disponibles}`;

          const modal = new bootstrap.Modal(document.getElementById('modalEvento'));
          modal.show();
        },

        eventDidMount: function(info) {
          const colores = ['#0d6efd', '#20c997', '#ffc107', '#fd7e14', '#6f42c1', '#dc3545'];
          const color = colores[info.event.id % colores.length];
          info.el.style.backgroundColor = color;
          info.el.style.borderColor = color;
        }
      });

      calendar.render();
    });
  </script>
{% endblock %}
