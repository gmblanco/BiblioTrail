{% extends "BibliotrailApp/base.html" %}
{% load static %}

{% block title %}
  <title>Eventos</title>
{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- TÃ­tulo y botÃ³n de calendario -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold" style="color: #4a77d4;">PrÃ³ximos eventos</h2>
    <a href="{% url 'calendario' %}?biblioteca={{ biblioteca }}" class="btn btn-outline-secondary">
      <i class="bi bi-calendar3 me-1"></i> Ver en calendario
    </a>
  </div>

  <!-- Selector de biblioteca -->
  <form method="get" action="{% url 'Eventos' %}" id="form-biblioteca" class="mb-4">
    <div class="row g-2 align-items-center">
      <div class="col-md-6">
        <label for="selector-biblioteca" class="form-label fw-semibold text-secondary">Selecciona una biblioteca:</label>
        <select name="biblioteca" class="form-select" id="selector-biblioteca">
            {% for nombre, url in bibliotecas.items %}
              <option value="{{ nombre }}" {% if biblioteca == nombre %}selected{% endif %}>
                {{ nombre|capfirst }}
              </option>
            {% endfor %}
        </select>
      </div>
    </div>
  </form>

  <!-- Lista de eventos -->
  {% if eventos %}
  <div class="row justify-content-center">
    {% for evento in eventos %}
      <div class="col-12 col-md-10 mb-4">
        <div class="card border-0 rounded-3" style="background-color: #f0f4ff;">
          <div class="row g-0">

            <!-- Detalles -->
            <div class="col-md-9 p-4">
              <h4 class="fw-bold mb-2" style="color: #4a77d4;">{{ evento.titulo }}</h4>
              <p class="mb-2 text-muted">
                <i class="bi bi-geo-alt me-1 text-secondary"></i>
                <strong>Lugar:</strong> {{ evento.lugar }}
              </p>

              <p class="mb-2">
                <span class="badge bg-light border text-secondary me-2">
                  {% if evento.fecha_fin and evento.fecha_inicio|date:"Y-m-d" != evento.fecha_fin|date:"Y-m-d" %}
                    {{ evento.fecha_inicio|date:"j \\d\\e F" }} â€“ {{ evento.fecha_fin|date:"j \\d\\e F" }}
                  {% else %}
                    {{ evento.fecha_inicio|date:"j \\d\\e F" }}
                  {% endif %}
                </span>
                <span class="badge bg-light border text-secondary">
                  ðŸ•’ {{ evento.fecha_inicio|date:"H:i" }}{% if evento.fecha_fin %} â€“ {{ evento.fecha_fin|date:"H:i" }}{% endif %}
                </span>
              </p>

              <p class="mt-3 text-secondary">
                <strong>DescripciÃ³n:</strong>
                <span id="descripcion-corta-{{ evento.id }}">
                  {{ evento.descripcion|slice:":200" }}...
                  <a href="javascript:void(0);" class="text-decoration-none" onclick="mostrarDescripcion('{{ evento.id }}')">Ver mÃ¡s</a>
                </span>
                <span id="descripcion-completa-{{ evento.id }}" style="display:none;">
                  {{ evento.descripcion }}
                </span>
              </p>
            </div>

            <!-- AcciÃ³n -->
            <div class="col-md-3 d-flex flex-column justify-content-center align-items-center p-3 border-start" style="background-color: #f0f4ff; border-left: 1px solid #dee2e6;">
              {% if evento.ya_inscrito %}
                <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                  <i class="bi bi-check2-circle me-1"></i> Ya inscrito
                </button>
              {% else %}
                <form method="post" action="{% url 'inscripcion_evento' evento.biblioteca_id evento.id %}" class="w-100">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success w-100 mb-2">
                    <i class="bi bi-pencil-fill me-1"></i> Inscribirse
                  </button>
                </form>
              {% endif %}

              {% if evento.plazas_disponibles == 0 %}
                <p class="text-danger mt-2 mb-0 fw-semibold text-center">Evento completo</p>
              {% else %}
                <p class="text-danger mt-2 mb-0 fw-semibold text-center">{{ evento.plazas_disponibles }} plazas disponibles</p>
              {% endif %}
            </div>


          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <div class="text-center text-muted mt-5">
      <i class="bi bi-calendar-x display-4"></i>
      <p class="mt-3 fs-5">No hay eventos disponibles en esta biblioteca.</p>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  function mostrarDescripcion(id) {
    document.getElementById('descripcion-corta-' + id).style.display = 'none';
    document.getElementById('descripcion-completa-' + id).style.display = 'inline';
  }

  document.getElementById("selector-biblioteca").addEventListener("change", function() {
    document.getElementById("form-biblioteca").submit();
  });
</script>
{% endblock %}
