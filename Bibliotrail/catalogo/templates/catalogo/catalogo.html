{% extends "BibliotrailApp/base.html" %}
{% load static %}

{% block title %}
    <title>Catalogo</title>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="row">
    <div class="col">
      <h2 class="mb-4 text-center text-primary fw-bold border-bottom pb-2">Catálogo de libros</h2>
    </div>
  </div>

  <form method="get" action="{% url 'buscar-libros' %}" class="mb-4">
    <!-- Barra de búsqueda principal -->
    <div class="row mb-2">
      <div class="col-md-12">
        <input type="text" name="q" placeholder="Buscar libros por título o autor..."
               value="{{ query }}" class="form-control form-control-lg" />
      </div>
    </div>
  
    <!-- Filtros: Biblioteca y Género -->
    <div class="row g-2">
      <div class="col-md-6">
        <select name="biblioteca" class="form-select">
          <option value="">Todas las bibliotecas</option>
          {% for nombre, url in bibliotecas.items %}
            <option value="{{ nombre }}" {% if biblioteca == nombre %}selected{% endif %}>
              {{ nombre|capfirst }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <select name="genero" class="form-select">
          <option value="">Todos los géneros</option>
          <option value="Misterio" {% if genero == 'Misterio' %}selected{% endif %}>Misterio</option>
          <option value="No Ficción" {% if genero == 'No Ficción' %}selected{% endif %}>No Ficción</option>
          <option value="Policial" {% if genero == 'Policial' %}selected{% endif %}>Policial</option>
          <option value="Aventura" {% if genero == 'Aventura' %}selected{% endif %}>Aventura</option>
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button type="submit" class="btn btn-success">Buscar</button>
      </div>
    </div>
  </form>
  

  <!-- Resultados -->
  {% if resultados %}
    <div class="row justify-content-center">
      {% for libro in resultados %}
        <div class="col-12 col-md-8 mb-4">
          <div class="card shadow-sm" style="background-color: #c9d7f0;">
            <div class="row g-0">
              <!-- Portada -->
              <div class="col-md-3 d-flex align-items-center">
                {% if libro.portada %}
                  <img src="{{ libro.portada }}" class="img-fluid rounded-start p-2" alt="Portada del libro">
                {% else %}
                  <img src="https://via.placeholder.com/180x240" class="img-fluid rounded-start p-2" alt="Portada no disponible">
                {% endif %}
              </div>

              <!-- Info -->
              <div class="col-md-7">
                <div class="card-body">
                  <h5 class="card-title">{{ libro.titulo }}</h5>
                  <p class="card-text">
                    <strong>Autor:</strong>
                    {% if libro.autor %}
                      <a href="{% url 'detalles_autor' %}?autor_id={{ libro.autor.id }}&biblioteca_url={{ libro.biblioteca_url }}">
                        {{ libro.autor.nombre }} {{ libro.autor.apellidos }}
                      </a>
                    {% else %}
                      <em>Autor no disponible</em>
                    {% endif %}
                    <br>
                    <strong>ISBN:</strong> {{ libro.isbn }}<br>
                    <strong>Editorial:</strong> {{ libro.editorial }}<br>
                    <strong>Resumen:</strong>
                    <span id="resumen-corto-{{ libro.id }}">
                      {{ libro.resumen|slice:":150" }}...
                      <a href="javascript:void(0);" onclick="mostrarResumen('{{ libro.id }}')">Ver más</a>
                    </span>
                    <span id="resumen-completo-{{ libro.id }}" style="display:none;">
                      {{ libro.resumen }}
                    </span>
                  </p>
                </div>
              </div>

              <!-- Botón reservar -->
              <div class="col-md-2 d-flex align-items-center justify-content-center p-2">
                <form method="get" action="{% url 'detalles_libro' %}">
                  <input type="hidden" name="libro_id" value="{{ libro.id }}">
                  <input type="hidden" name="biblioteca_url" value="{{ libro.biblioteca_url }}">
                  <button type="submit" class="btn btn-danger btn-sm">Reservar</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% elif query %}
    <div class="text-center text-muted mt-5">
      <p>No se encontraron libros con esos criterios.</p>
    </div>
  {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
  function mostrarResumen(id) {
    document.getElementById('resumen-corto-' + id).style.display = 'none';
    document.getElementById('resumen-completo-' + id).style.display = 'inline';
  }
</script>
{% endblock %}
