{% extends "BibliotrailApp/base.html" %}
{% load static %}

{% block title %}
    <title>Catalogo</title>
{% endblock %}

{% block content %}
  <h1>Resultados de búsqueda</h1>

  <form method="get" action="{% url 'buscar-libros' %}">
    <input type="text" name="q" placeholder="Buscar libros..." value="{{ query }}">
    <button type="submit">Buscar</button>
  </form>

  {% if resultados %}
  <div class="container">
    <div class="row justify-content-center">
      {% for libro in resultados %}
        <div class="col-12 col-md-8 mb-4">
          <div class="card text-dark" style="background-color: #c9d7f0;">
            <div class="d-flex" style="height: 100%;">

              <!--Sección izquierda: portada -->
              <div class="p-2">
                <img src="{{ libro.imagen_url|default:'https://via.placeholder.com/150x200' }}" 
                     class="img-fluid" 
                     style="width: 150px; height: 100%; object-fit: cover;" 
                     alt="Portada del libro">
              </div>

              <!-- Línea vertical -->
              <div class="vr mx-2"></div>

              <!--Sección central-->
              <div class="flex-grow-1 p-2">
                <h5 class="card-title">{{ libro.titulo }}</h5>
                <p class="card-text mb-2">
                  <strong>Autor:</strong>
                {% if libro.autor %}
                  <a href="{% url 'detalles_autor' %}?autor_id={{ libro.autor.id }}&biblioteca_url={{ libro.biblioteca_url }}">
                    {{ libro.autor.nombre }} {{ libro.autor.apellidos }}
                  </a>
                {% else %}
                  <em>Autor no disponible</em>
                {% endif %}
                  <br>
                  <strong>ISBN:</strong> {{ libro.isbn }}<br>
                  <strong>Resumen:</strong>
                  <span id="resumen-corto-{{ libro.id }}">
                    {{ libro.resumen|slice:":150" }}...
                    <a href="javascript:void(0);" onclick="mostrarResumen('{{ libro.id }}')">Ver más</a>
                  </span>
                  <span id="resumen-completo-{{ libro.id }}" style="display:none;">
                    {{ libro.resumen }}
                  </span><br>
                  <strong>Editorial:</strong> {{ libro.editorial }}
                </p>
              </div>

              <!--Línea vertical-->
              <div class="vr mx-2"></div>

              <!--Sección derecha -->
              <div class="d-flex align-items-center pe-3">
                <form method="get" action="{% url 'detalles_libro' %}">
                  <input type="hidden" name="libro_id" value="{{ libro.id }}">
                  <input type="hidden" name="biblioteca_url" value="{{ libro.biblioteca_url }}">
                  <button type="submit" class="btn btn-danger btn-sm">Reservar</button>
                </form>                
              </div>

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% elif query %}
  <p class="text-center">No se encontraron libros.</p>
{% endif %}


{% endblock %}

{% block scripts %}
<script>
  function mostrarResumen(id) {
    document.getElementById('resumen-corto-' + id).style.display = 'none';
    document.getElementById('resumen-completo-' + id).style.display = 'inline';
  }
</script>
{% endblock %}

<!--
% block content %
<h1>Inicio BiblioTrail</h1>

  <p>Bienvenido a <em>BiblioTrail</em>!!</p>

<h2>Dynamic content</h2>

  <p>The library has the following record counts:</p>
  <ul>
    <li><strong>Libros:</strong> {{ num_libros }}</li>
    <li><strong>Copias:</strong> {{ num_ejemplares }}</li>
    <li><strong>Copias disponibles:</strong> {{ num_ejemplares_disponibles }}</li>
    <li><strong>Autores:</strong> {{ num_autores }}</li>
    <li><strong>Géneros:</strong> {{ num_generos }}</li>
    <li><strong>Idiomas:</strong> {{ num_idiomas }}</li>
  </ul>
  
  <button id="buscarLibros" class="btn btn-primary mt-2 mt-sm-0" style="background-color: #6595f0;">Buscar Libros</button>
  <ul id="listaLibros">AAAA</ul>
-->
<!-- Scripts JS 
<script>
document.getElementById("buscarLibros").addEventListener("click", function() {
    // URLs de las APIs de las bibliotecas
    const apis = [
        "http://127.0.0.1:8001/api/libros/",  // API de libros
    ];

    // Hacer peticiones a todas las APIs
    Promise.all(apis.map(url =>
        fetch(url)
            .then(response => response.json())
            .catch(error => console.error("Error al obtener datos de la API:", error))
    ))
    .then(results => {
        let lista = document.getElementById("listaLibros");
        lista.innerHTML = "";  // Borra los resultados anteriores

        // Verificar los datos de la respuesta
        console.log(results);

        // Combinar los resultados de todas las APIs
        results.forEach(apiLibros => {
            apiLibros.forEach(libro => {
                let li = document.createElement("li");

                // Comprobar que los campos están bien definidos
                const autores = libro.autor 
                  ? libro.autor.map(a => `${a.nombre} ${a.apellidos}`).join(", ") 
                  : "Autor no disponible";
                const titulo = libro.titulo || "Título no disponible";

                // Añadir el título y el autor al elemento de la lista
                li.textContent = `${titulo} - ${autores}`;
                lista.appendChild(li);
            });
        });
    })
    .catch(error => console.error("Error al combinar las respuestas de las APIs:", error));
});
</script>

  <p>Has visitado esta pagina {{ num_visitas }}{% if num_visitas == 1 %} vez{% else %} veces{% endif %}.</p>
% endblock %
-->